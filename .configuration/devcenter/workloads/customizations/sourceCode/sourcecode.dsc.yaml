# yaml-language-server: $schema=https://raw.githubusercontent.com/microsoft/winget-cli/refs/heads/master/schemas/JSON/configuration/configuration.schema.0.2.json

#
# Identity Provider Dev Environment Configuration
# Purpose: Sets up development environment for Identity Provider project
# Version: 1.0
# Last Updated: Current date
# Usage: Applied via DevCenter to provision development environments
#

properties:
  configurationVersion: 0.2.0
  resources:
    - resource: PSDscResources/Script
      id: dotnetbuild
      directives:
        description: Build and test Identity Provider solution
        allowPrerelease: true
        securityContext: elevated
      settings:
        SetScript: |
          # Enable script execution and set up environment
          Set-ExecutionPolicy Bypass -Scope Process -Force
          $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")

          # Define repository path consistently
          $repoPath = "Z:\workspaces\IdentityProvider"

          # Build the Identity Provider solution
          try {
              Write-Host "Building Identity Provider solution..."
              dotnet restore $repoPath\IdentityProvider.sln --configuration Release --verbosity normal
              dotnet test $repoPath\IdentityProvider.sln --configuration Release --no-restore --verbosity normal
              dotnet build $repoPath\IdentityProvider.sln --configuration Release --no-restore --verbosity normal
              Write-Host "Build completed successfully"
          }
          catch {
              Write-Error "Build failed: $_"
              throw "Build failed. See error above."
          }
        GetScript: return $false
        TestScript: return $false
