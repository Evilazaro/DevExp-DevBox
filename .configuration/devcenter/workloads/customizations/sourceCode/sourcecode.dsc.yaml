# yaml-language-server: $schema=https://raw.githubusercontent.com/microsoft/winget-cli/refs/heads/master/schemas/JSON/configuration/configuration.schema.0.2.json

#
# Identity Provider Dev Environment Configuration
# Purpose: Sets up development environment for Identity Provider project
# Version: 1.0
# Last Updated: Current date
# Usage: Applied via DevCenter to provision development environments
#

properties:
  configurationVersion: 0.2.0
  resources:
    - resource: PSDscResources/Script
      id: GitClone
      directives:
        description: Clone Identity Provider repository
        allowPrerelease: true
        securityContext: elevated
      settings:
        SetScript: |
          # Enable script execution and set up environment
          Set-ExecutionPolicy Bypass -Scope Process -Force
          $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
          
          # Define repository path consistently
          $repoPath = "Z:\workspaces\IdentityProvider"

          # Clone the Identity Provider repository
          try {
              Write-Host "Cloning Identity Provider repository..."
              git clone https://github.com/Evilazaro/IdentityProvider/ $repoPath
              Write-Host "Repository cloned successfully to $repoPath"
          }
          catch {
              Write-Error "Failed to clone repository: $_"
              throw "Repository clone failed. See error above."
          }
        GetScript: return $false
        TestScript: return $false
    - resource: PSDscResources/Script
      id: WorkloadUpdate
      directives:
        description: Update .NET SDK workloads
        allowPrerelease: true
        securityContext: elevated
      settings:
        SetScript: |
          # Enable script execution and set up environment
          Set-ExecutionPolicy Bypass -Scope Process -Force
          $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
          
          # Update all installed .NET workloads to ensure latest versions
          try {
              Write-Host "Updating .NET SDK workloads..."
              dotnet workload update
              Write-Host ".NET workloads updated successfully"
          }
          catch {
              Write-Error "Failed to update .NET workloads: $_"
              throw "Workload update failed. See error above."
          }
        GetScript: return $false
        TestScript: return $false

    - resource: PSDscResources/Script
      id: dotnetbuild
      directives:
        description: Build and test Identity Provider solution
        allowPrerelease: true
        securityContext: elevated
      settings:
        SetScript: |
          # Enable script execution and set up environment
          Set-ExecutionPolicy Bypass -Scope Process -Force
          $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
          
          # Define repository path consistently
          $repoPath = "Z:\workspaces\IdentityProvider"

          # Build the Identity Provider solution
          try {
              Write-Host "Building Identity Provider solution..."
              dotnet restore $repoPath\IdentityProvider.sln --configuration Release --verbosity normal
              dotnet test $repoPath\IdentityProvider.sln --configuration Release --no-restore --verbosity normal
              dotnet build $repoPath\IdentityProvider.sln --configuration Release --no-restore --verbosity normal
              Write-Host "Build completed successfully"
          }
          catch {
              Write-Error "Build failed: $_"
              throw "Build failed. See error above."
          }
        GetScript: return $false
        TestScript: return $false