# yaml-language-server: $schema=https://aka.ms/configuration-dsc-schema/0.2
properties:
  configurationVersion: "0.2.0"
  # This DSC configuration enables Windows virtualization features.
  # 
  # Purpose:
  # Sets up Windows Subsystem for Linux (WSL) to support Linux workloads
  # on Windows development environments.
  #
  # Components:
  # - WSL: Windows Subsystem for Linux with Ubuntu distribution
  resources:
    # Install Windows Subsystem for Linux (WSL)
    # Enables the WSL feature and installs Ubuntu distribution for Linux development
    - resource: PSDscResources/Script
      id: Microsoft-Windows-Subsystem-Linux
      directives:
        description: Enable Windows Features and Install Ubuntu for WSL
        securityContext: elevated
      settings:
        SetScript: |
          Write-Verbose "Installing Windows Subsystem for Linux (WSL)" -Verbose
          wsl --install --no-launch --quiet
          wsl --install -d Ubuntu --no-launch --quiet
          $newUser = $env:USERNAME.ToLower()
          # Generate a random secure password instead of hardcoding
          $securePassword = [System.Web.Security.Membership]::GeneratePassword(16, 4)
          $escapedPassword = $securePassword -replace '(["\\$`])', '\\$1'  # Escape for bash

          # Create user account in Ubuntu
          wsl.exe -d Ubuntu -u root -- bash -c "sudo adduser --quiet --disabled-password --gecos '' $newUser"
          # Set the generated password for the user
          wsl.exe -d Ubuntu -u root -- bash -c "echo '${newUser}:${escapedPassword}' | sudo chpasswd"
          # Add user to sudo group for administrative privileges
          wsl.exe -d Ubuntu -u root -- bash -c "sudo usermod -aG sudo $newUser"
          # Allow passwordless sudo for convenience in development environment
          wsl.exe -d Ubuntu -u root -- bash -c "echo '$newUser ALL=(ALL) NOPASSWD:ALL' | sudo tee /etc/sudoers.d/$newUser"
        GetScript: return $false
        TestScript: return $false

    # Update Ubuntu packages
    # Ensures the Ubuntu distribution has the latest updates installed
    - resource: PSDscResources/Script
      id: Ubuntu
      directives:
        description: Update and upgrade Ubuntu packages
        securityContext: elevated
      settings:
        SetScript: |
          # Update package lists
          wsl.exe -d Ubuntu -u root -- bash -c "sudo apt-get update" --quiet
          # Upgrade installed packages to latest versions
          wsl.exe -d Ubuntu -u root -- bash -c "sudo apt-get upgrade -y" --quiet
        GetScript: return $false
        TestScript: return $false
