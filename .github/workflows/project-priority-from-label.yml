name: Set Project Priority from Issue Label

on:
  schedule:
    - cron: '*/15 * * * *'  # Run every 15 minutes
  workflow_dispatch:
    inputs:
      project_number:
        description: 'Project number (optional, will process all projects if not specified)'
        required: false

permissions:
  issues: read
  contents: read
  projects: read

jobs:
  sync-priorities:
    runs-on: ubuntu-latest

    steps:
      - name: Sync issue priorities to project
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const projectNumber = "${{ github.event.inputs.project_number }}" || null;
            
            // Get organization/user and repository info
            const repoInfo = await github.rest.repos.get({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            
            const isOrgRepo = repoInfo.data.owner.type === 'Organization';
            
            // Get all organization/user projects linked to this repository
            const projectsQuery = isOrgRepo ? `
              query($org: String!) {
                organization(login: $org) {
                  projectsV2(first: 100) {
                    nodes {
                      id
                      number
                      title
                      repositories(first: 100) {
                        nodes {
                          name
                        }
                      }
                    }
                  }
                }
              }
            ` : `
              query($owner: String!) {
                user(login: $owner) {
                  projectsV2(first: 100) {
                    nodes {
                      id
                      number
                      title
                      repositories(first: 100) {
                        nodes {
                          name
                        }
                      }
                    }
                  }
                }
              }
            `;
            
            const projectsResult = await github.graphql(projectsQuery, 
              isOrgRepo 
                ? { org: context.repo.owner }
                : { owner: context.repo.owner }
            );
            
            // Get all projects and filter those linked to this repository
            const allProjects = isOrgRepo 
              ? projectsResult.organization?.projectsV2?.nodes || []
              : projectsResult.user?.projectsV2?.nodes || [];
            
            let projects = allProjects.filter(p => 
              p.repositories?.nodes?.some(r => r.name === context.repo.repo)
            );
            
            core.info(`Found ${projects.length} projects linked to this repository`);
            
            // Filter to specific project if requested
            if (projectNumber) {
              const filtered = projects.filter(p => p.number === parseInt(projectNumber));
              if (filtered.length === 0) {
                core.warning(`Project #${projectNumber} not found. Available projects: ${projects.map(p => `#${p.number} (${p.title})`).join(', ')}`);
              }
              projects = filtered;
            }
            
            if (projects.length === 0) {
              core.info('No projects found linked to this repository');
              if (allProjects.length > 0) {
                core.info(`Total projects in ${isOrgRepo ? 'organization' : 'user account'}: ${allProjects.length}`);
                core.info('Make sure the projects are linked to this repository in project settings');
              }
              return;
            }
            
            // Process each project
            let totalUpdated = 0;
            for (const project of projects) {
              core.info(`\n=== Processing project: ${project.title} (#${project.number}) ===`);
              
              // Get Priority field configuration
              const fieldsQuery = `
                query($projectId: ID!) {
                  node(id: $projectId) {
                    ... on ProjectV2 {
                      fields(first: 20) {
                        nodes {
                          ... on ProjectV2SingleSelectField {
                            id
                            name
                            options {
                              id
                              name
                            }
                          }
                        }
                      }
                    }
                  }
                }
              `;
              
              const fieldsResult = await github.graphql(fieldsQuery, { projectId: project.id });
              const priorityField = fieldsResult.node.fields.nodes.find(f => f.name === "Priority");
              
              if (!priorityField) {
                const availableFields = fieldsResult.node.fields.nodes
                  .map(f => f.name)
                  .filter(name => name)
                  .join(', ');
                core.warning(`No Priority field found in project ${project.title}. Available single-select fields: ${availableFields || 'none'}`);
                continue;
              }
              
              core.info(`Found Priority field with options: ${priorityField.options?.map(o => o.name).join(', ') || 'none'}`);
              
              // Get all items in the project
              const itemsQuery = `
                query($projectId: ID!, $after: String) {
                  node(id: $projectId) {
                    ... on ProjectV2 {
                      items(first: 100, after: $after) {
                        pageInfo {
                          hasNextPage
                          endCursor
                        }
                        nodes {
                          id
                          content {
                            ... on Issue {
                              number
                              labels(first: 20) {
                                nodes {
                                  name
                                }
                              }
                            }
                          }
                          fieldValueByName(name: "Priority") {
                            ... on ProjectV2ItemFieldSingleSelectValue {
                              name
                            }
                          }
                        }
                      }
                    }
                  }
                }
              `;
              
              let hasNextPage = true;
              let afterCursor = null;
              let updatedCount = 0;
              
              while (hasNextPage) {
                const itemsResult = await github.graphql(itemsQuery, {
                  projectId: project.id,
                  after: afterCursor
                });
                
                const items = itemsResult.node.items;
                hasNextPage = items.pageInfo.hasNextPage;
                afterCursor = items.pageInfo.endCursor;
                
                // Process each item
                for (const item of items.nodes) {
                  if (!item.content || !item.content.labels) continue;
                  
                  // Find priority label on the issue
                  const priorityLabel = item.content.labels.nodes
                    .map(l => l.name)
                    .find(name => name.startsWith("priority:p"));
                  
                  if (!priorityLabel) continue;
                  
                  const desiredPriority = priorityLabel.replace("priority:", "").toUpperCase();
                  const currentPriority = item.fieldValueByName?.name?.toUpperCase();
                  
                  // Skip if already set correctly
                  if (currentPriority === desiredPriority) continue;
                  
                  // Find the priority option
                  const priorityOption = priorityField.options?.find(
                    o => o.name?.toUpperCase() === desiredPriority
                  );
                  
                  if (!priorityOption) {
                    core.warning(`Priority option ${desiredPriority} not found for issue #${item.content.number}`);
                    continue;
                  }
                  
                  // Update the priority
                  try {
                    await github.graphql(`
                      mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                        updateProjectV2ItemFieldValue(
                          input: {
                            projectId: $projectId
                            itemId: $itemId
                            fieldId: $fieldId
                            value: { singleSelectOptionId: $optionId }
                          }
                        ) {
                          projectV2Item {
                            id
                          }
                        }
                      }
                    `, {
                      projectId: project.id,
                      itemId: item.id,
                      fieldId: priorityField.id,
                      optionId: priorityOption.id
                    });
                    
                    core.info(`✓ Updated issue #${item.content.number} to ${desiredPriority}`);
                    updatedCount++;
                  } catch (error) {
                    core.error(`Failed to update issue #${item.content.number}: ${error.message}`);
                  }
                }
              }
              
              core.info(`Project ${project.title}: Updated ${updatedCount} items`);
              totalUpdated += updatedCount;
            }
            
            core.info(`\n✅ Summary: Updated ${totalUpdated} total items across ${projects.length} project(s)`);
