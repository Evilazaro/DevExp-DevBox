name: Set Project Priority from Issue Label

on:
  schedule:
    - cron: '*/15 * * * *'  # Run every 15 minutes
  workflow_dispatch:
    inputs:
      project_number:
        description: 'Project number (optional, will process all projects if not specified)'
        required: false

permissions:
  issues: read
  contents: read

jobs:
  sync-priorities:
    runs-on: ubuntu-latest

    steps:
      - name: Sync issue priorities to project
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const projectNumber = "${{ github.event.inputs.project_number }}" || null;
            
            // Get all repository projects or specific project
            const projectsQuery = `
              query($owner: String!, $repo: String!) {
                repository(owner: $owner, name: $repo) {
                  projectsV2(first: 20) {
                    nodes {
                      id
                      number
                      title
                    }
                  }
                }
              }
            `;
            
            const projectsResult = await github.graphql(projectsQuery, {
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            
            let projects = projectsResult.repository.projectsV2.nodes;
            
            // Filter to specific project if requested
            if (projectNumber) {
              projects = projects.filter(p => p.number === parseInt(projectNumber));
            }
            
            if (projects.length === 0) {
              core.info('No projects found');
              return;
            }
            
            // Process each project
            for (const project of projects) {
              core.info(`Processing project: ${project.title} (#${project.number})`);
              
              // Get Priority field configuration
              const fieldsQuery = `
                query($projectId: ID!) {
                  node(id: $projectId) {
                    ... on ProjectV2 {
                      fields(first: 20) {
                        nodes {
                          ... on ProjectV2SingleSelectField {
                            id
                            name
                            options {
                              id
                              name
                            }
                          }
                        }
                      }
                    }
                  }
                }
              `;
              
              const fieldsResult = await github.graphql(fieldsQuery, { projectId: project.id });
              const priorityField = fieldsResult.node.fields.nodes.find(f => f.name === "Priority");
              
              if (!priorityField) {
                core.warning(`No Priority field found in project ${project.title}`);
                continue;
              }
              
              // Get all items in the project
              const itemsQuery = `
                query($projectId: ID!, $after: String) {
                  node(id: $projectId) {
                    ... on ProjectV2 {
                      items(first: 100, after: $after) {
                        pageInfo {
                          hasNextPage
                          endCursor
                        }
                        nodes {
                          id
                          content {
                            ... on Issue {
                              number
                              labels(first: 20) {
                                nodes {
                                  name
                                }
                              }
                            }
                          }
                          fieldValueByName(name: "Priority") {
                            ... on ProjectV2ItemFieldSingleSelectValue {
                              name
                            }
                          }
                        }
                      }
                    }
                  }
                }
              `;
              
              let hasNextPage = true;
              let afterCursor = null;
              let updatedCount = 0;
              
              while (hasNextPage) {
                const itemsResult = await github.graphql(itemsQuery, {
                  projectId: project.id,
                  after: afterCursor
                });
                
                const items = itemsResult.node.items;
                hasNextPage = items.pageInfo.hasNextPage;
                afterCursor = items.pageInfo.endCursor;
                
                // Process each item
                for (const item of items.nodes) {
                  if (!item.content || !item.content.labels) continue;
                  
                  // Find priority label on the issue
                  const priorityLabel = item.content.labels.nodes
                    .map(l => l.name)
                    .find(name => name.startsWith("priority:p"));
                  
                  if (!priorityLabel) continue;
                  
                  const desiredPriority = priorityLabel.replace("priority:", "").toUpperCase();
                  const currentPriority = item.fieldValueByName?.name?.toUpperCase();
                  
                  // Skip if already set correctly
                  if (currentPriority === desiredPriority) continue;
                  
                  // Find the priority option
                  const priorityOption = priorityField.options.find(
                    o => o.name.toUpperCase() === desiredPriority
                  );
                  
                  if (!priorityOption) {
                    core.warning(`Priority option ${desiredPriority} not found for issue #${item.content.number}`);
                    continue;
                  }
                  
                  // Update the priority
                  try {
                    await github.graphql(`
                      mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                        updateProjectV2ItemFieldValue(
                          input: {
                            projectId: $projectId
                            itemId: $itemId
                            fieldId: $fieldId
                            value: { singleSelectOptionId: $optionId }
                          }
                        ) {
                          projectV2Item {
                            id
                          }
                        }
                      }
                    `, {
                      projectId: project.id,
                      itemId: item.id,
                      fieldId: priorityField.id,
                      optionId: priorityOption.id
                    });
                    
                    core.info(`âœ“ Updated issue #${item.content.number} to ${desiredPriority}`);
                    updatedCount++;
                  } catch (error) {
                    core.error(`Failed to update issue #${item.content.number}: ${error.message}`);
                  }
                }
              }
              
              core.info(`Project ${project.title}: Updated ${updatedCount} items`);
            }
