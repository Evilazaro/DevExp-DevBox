name: Set Project Priority from Issue Label

on:
  issues:
    types: [opened, labeled, assigned]
  workflow_dispatch:
    inputs:
      project_id:
        description: 'Project Node ID'
        required: true
      item_id:
        description: 'Item ID'
        required: true
      issue_number:
        description: 'Issue number'
        required: true

permissions:
  issues: read
  contents: read

jobs:
  set-priority:
    runs-on: ubuntu-latest

    steps:
      - name: Get issue and project details
        id: get-details
        uses: actions/github-script@v7
        with:
          script: |
            let issueNumber, projectId, itemId;

            if (context.eventName === 'issues') {
              // Automatic trigger from issue event
              issueNumber = context.payload.issue.number;
              
              // Query to find projects this issue is associated with
              const query = `
                query($owner: String!, $repo: String!, $issueNumber: Int!) {
                  repository(owner: $owner, name: $repo) {
                    issue(number: $issueNumber) {
                      projectItems(first: 10) {
                        nodes {
                          id
                          project {
                            id
                            title
                          }
                        }
                      }
                    }
                  }
                }
              `;

              const result = await github.graphql(query, {
                owner: context.repo.owner,
                repo: context.repo.repo,
                issueNumber: issueNumber
              });

              const projectItems = result.repository.issue.projectItems.nodes;
              
              if (projectItems.length === 0) {
                core.info('Issue is not associated with any project, skipping.');
                return;
              }

              // Use the first project (you can modify this logic as needed)
              projectId = projectItems[0].project.id;
              itemId = projectItems[0].id;
              
              core.info(`Found issue in project: ${projectItems[0].project.title}`);
            } else {
              // Manual trigger via workflow_dispatch
              issueNumber = "${{ github.event.inputs.issue_number }}";
              projectId = "${{ github.event.inputs.project_id }}";
              itemId = "${{ github.event.inputs.item_id }}";
            }

            core.setOutput("issue_number", issueNumber);
            core.setOutput("project_id", projectId);
            core.setOutput("item_id", itemId);

      - name: Extract issue labels
        id: labels
        if: steps.get-details.outputs.issue_number != ''
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.get-details.outputs.issue_number }}
            });

            const priorityLabel = issue.data.labels
              .map(l => l.name)
              .find(name => name.startsWith("priority:p"));

            if (!priorityLabel) {
              core.info("No priority label found.");
              return;
            }

            core.setOutput("priority", priorityLabel.replace("priority:", "").toUpperCase());

      - name: Set Priority field in Project
        if: steps.labels.outputs.priority != ''
        uses: actions/github-script@v7
        with:
          script: |
            const priority = "${{ steps.labels.outputs.priority }}";
            const projectId = "${{ steps.get-details.outputs.project_id }}";
            const itemId = "${{ steps.get-details.outputs.item_id }}";

            const fields = await github.graphql(`
              query($projectId: ID!) {
                node(id: $projectId) {
                  ... on ProjectV2 {
                    fields(first: 20) {
                      nodes {
                        ... on ProjectV2SingleSelectField {
                          id
                          name
                          options {
                            id
                            name
                          }
                        }
                      }
                    }
                  }
                }
              }
            `, { projectId });

            const priorityField = fields.node.fields.nodes.find(
              f => f.name === "Priority"
            );

            if (!priorityField) {
              throw new Error("Priority field not found in project");
            }

            const option = priorityField.options.find(
              o => o.name.toUpperCase() === priority
            );

            if (!option) {
              throw new Error(`Priority option ${priority} not found`);
            }

            await github.graphql(`
              mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                updateProjectV2ItemFieldValue(
                  input: {
                    projectId: $projectId
                    itemId: $itemId
                    fieldId: $fieldId
                    value: { singleSelectOptionId: $optionId }
                  }
                ) {
                  projectV2Item {
                    id
                  }
                }
              }
            `, {
              projectId,
              itemId,
              fieldId: priorityField.id,
              optionId: option.id
            });
