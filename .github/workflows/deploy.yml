# =============================================================================
# File: deploy.yml
# Purpose: Azure deployment workflow for Dev Box Accelerator
# Description: Provisions infrastructure to Azure using azd with OIDC authentication
# Triggers: Manual workflow dispatch only
# =============================================================================

name: Deploy to Azure

# Workflow triggers - manual dispatch with customizable inputs
on:
  workflow_dispatch:
    inputs:
      AZURE_ENV_NAME:
        description: "Azure environment name (e.g., dev, staging, prod)"
        required: true
        default: "demo"
        type: string
      AZURE_LOCATION:
        description: "Azure region for deployment (e.g., eastus, westus)"
        required: true
        default: "eastus2"
        type: string

# Minimal permissions for OIDC authentication
# https://learn.microsoft.com/en-us/azure/developer/github/connect-from-azure?tabs=azure-portal%2Clinux#set-up-azure-login-with-openid-connect-authentication
permissions:
  id-token: write # Required for requesting OIDC JWT token
  contents: read # Required for actions/checkout

# Prevent concurrent deployments to the same environment
concurrency:
  group: deploy-${{ github.event.inputs.AZURE_ENV_NAME || 'default' }}
  cancel-in-progress: false

jobs:
  # -----------------------------------------------------------------------------
  # Job: build-and-deploy-to-azure
  # Purpose: Build Bicep templates and deploy infrastructure to Azure
  # -----------------------------------------------------------------------------
  build-and-deploy-to-azure:
    name: Build and Deploy to Azure
    runs-on: ubuntu-latest
    timeout-minutes: 60
    environment:
      name: ${{ inputs.AZURE_ENV_NAME }}

    env:
      AZURE_CLIENT_ID: ${{ vars.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ vars.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ vars.AZURE_SUBSCRIPTION_ID }}
      AZURE_ENV_NAME: ${{ inputs.AZURE_ENV_NAME || 'devexp2' }}
      AZURE_LOCATION: ${{ inputs.AZURE_LOCATION || vars.AZURE_LOCATION }}

    steps:
      - name: Validate Required Variables
        run: |
          echo "::group::Validating Azure configuration"
          missing_vars=""

          if [ -z "${{ vars.AZURE_CLIENT_ID }}" ]; then
            missing_vars="${missing_vars}AZURE_CLIENT_ID "
          fi
          if [ -z "${{ vars.AZURE_TENANT_ID }}" ]; then
            missing_vars="${missing_vars}AZURE_TENANT_ID "
          fi
          if [ -z "${{ vars.AZURE_SUBSCRIPTION_ID }}" ]; then
            missing_vars="${missing_vars}AZURE_SUBSCRIPTION_ID "
          fi

          if [ -n "$missing_vars" ]; then
            echo "::error::Missing required repository variables: $missing_vars"
            exit 1
          fi

          echo "âœ… All required variables are configured"
          echo "::endgroup::"

      - name: Checkout Repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Azure Developer CLI
        uses: Azure/setup-azd@ae0f8b5482eeac61e940f447327d84c73beb8b1e # v2.1.0

      - name: Build Bicep Templates
        id: build
        run: |
          echo "::group::Building Bicep templates"
          echo "âœ… Building Bicep templates..."
          mkdir -p ./artifacts

          # Check if Azure CLI is available
          if command -v az &> /dev/null; then
            az bicep build --file ./infra/main.bicep --outdir ./artifacts
            echo "âœ… Bicep build completed successfully"
          else
            echo "::error::Azure CLI not available - cannot build Bicep templates"
            exit 1
          fi
          echo "::endgroup::"

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: bicep-artifacts-${{ github.run_number }}
          path: ./artifacts
          compression-level: 6
          if-no-files-found: error
          retention-days: 7

      - name: Generate Build Summary
        run: |
          echo "## ðŸ“¦ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | \`${{ env.AZURE_ENV_NAME }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Location | \`${{ env.AZURE_LOCATION }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Run | [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |" >> $GITHUB_STEP_SUMMARY

      - name: Authenticate with Azure (OIDC)
        id: azure_auth
        run: |
          echo "::group::Authenticating with Azure"
          azd auth login `
            --client-id "$Env:AZURE_CLIENT_ID" `
            --federated-credential-provider "github" `
            --tenant-id "$Env:AZURE_TENANT_ID"
          echo "âœ… Successfully authenticated with Azure"
          echo "::endgroup::"
        shell: pwsh

      - name: Deploy Infrastructure to Azure
        id: deploy
        run: |
          echo "::group::Deploying to Azure"
          echo "Environment: ${{ env.AZURE_ENV_NAME }}"
          echo "Location: ${{ env.AZURE_LOCATION }}"
          azd provision --no-prompt
          echo "âœ… Deployment completed successfully"
          echo "::endgroup::"
        env:
          KEY_VAULT_SECRET: ${{ secrets.KEY_VAULT_SECRET }}
          SOURCE_CONTROL_PLATFORM: "github"

      - name: Generate Deployment Summary
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸš€ Deployment Result" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.deploy.outcome }}" == "success" ]; then
            echo "âœ… **Deployment succeeded**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Deployment failed**" >> $GITHUB_STEP_SUMMARY
          fi
