# =============================================================================
# File: release.yml
# Purpose: Branch-based release strategy workflow for Dev Box Accelerator
# Description: Generates semantic versions and publishes GitHub releases
# Triggers: Manual workflow dispatch
# =============================================================================

name: Branch-Based Release Strategy

# Workflow triggers
on:
  workflow_dispatch:
    inputs:
      force_release:
        description: "Force create a release (even for non-main branches)"
        required: false
        default: false
        type: boolean

# Least-privilege permissions
permissions:
  contents: write # Required for creating tags and releases
  pull-requests: read # Required for PR information
  actions: read # Required for workflow introspection

# Prevent concurrent releases
concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # -----------------------------------------------------------------------------
  # Job: generate-release
  # Purpose: Calculate semantic version and prepare release metadata
  # -----------------------------------------------------------------------------
  generate-release:
    name: Generate Release Metadata
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      new_version: ${{ steps.release.outputs.new_version }}
      release_type: ${{ steps.release.outputs.release_type }}
      previous_tag: ${{ steps.release.outputs.previous_tag }}
      should_release: ${{ steps.release.outputs.should_release }}
      should_publish: ${{ steps.release.outputs.should_publish }}
      branch_name: ${{ steps.release.outputs.branch_name }}
      commit_sha: ${{ github.sha }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ github.event_name == 'pull_request' && github.head_ref || github.ref }}
          fetch-depth: 0 # Full history for proper tag analysis

      - name: Generate Release Information
        id: release
        uses: ./.github/actions/ci/generate-release

      - name: Release Strategy Summary
        shell: bash
        run: |
          echo "## ğŸŒŸ Release Strategy Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ”€ Branch | \`${{ steps.release.outputs.branch_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ·ï¸ Version | \`${{ steps.release.outputs.new_version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“¦ Previous | \`${{ steps.release.outputs.previous_tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸš€ Type | \`${{ steps.release.outputs.release_type }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ¤– Trigger | \`${{ github.event_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“ Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY

  # -----------------------------------------------------------------------------
  # Job: build
  # Purpose: Compile Bicep templates and create versioned artifacts
  # -----------------------------------------------------------------------------
  build:
    name: Build Artifacts
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: generate-release
    if: needs.generate-release.outputs.should_release == 'true'

    steps:
      - name: Checkout Repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ github.event_name == 'pull_request' && github.head_ref || github.ref }}
          fetch-depth: 0

      - name: Build Bicep Templates
        id: build
        uses: ./.github/actions/ci/bicep-standard-ci
        with:
          branch_name: ${{ needs.generate-release.outputs.branch_name }}
          new_version: ${{ needs.generate-release.outputs.new_version }}
          should_publish: ${{ needs.generate-release.outputs.should_publish }}

      - name: Build Summary
        shell: bash
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“¦ Build Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“„ Bicep templates compiled to ARM templates" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ—ï¸ Infrastructure deployment files" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“‹ Version: \`${{ needs.generate-release.outputs.new_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ”€ Branch: \`${{ needs.generate-release.outputs.branch_name }}\`" >> $GITHUB_STEP_SUMMARY

  # -----------------------------------------------------------------------------
  # Job: publish-release
  # Purpose: Create and publish GitHub Release with artifacts
  # -----------------------------------------------------------------------------
  publish-release:
    name: Publish GitHub Release
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [generate-release, build]
    if: |
      always() &&
      needs.generate-release.outputs.should_release == 'true' && 
      needs.build.result == 'success' &&
      (needs.generate-release.outputs.should_publish == 'true' || 
       github.event.inputs.force_release == 'true')

    steps:
      - name: Checkout Repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ github.event_name == 'pull_request' && github.head_ref || github.ref }}
          fetch-depth: 0

      - name: Download Build Artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: artifacts-${{ needs.generate-release.outputs.new_version }}
          path: ./artifacts

      - name: Generate Release Notes
        id: release_notes
        shell: bash
        run: |
          branch_name="${{ needs.generate-release.outputs.branch_name }}"
          release_type="${{ needs.generate-release.outputs.release_type }}"
          previous_tag="${{ needs.generate-release.outputs.previous_tag }}"
          new_version="${{ needs.generate-release.outputs.new_version }}"
          commit_sha="${{ needs.generate-release.outputs.commit_sha }}"

          # Determine if this is a prerelease
          is_prerelease="false"
          if [[ "$branch_name" != "main" ]] || [[ "$new_version" == *"-"* ]]; then
            is_prerelease="true"
          fi

          # Generate release body
          cat > release_notes.md << EOF
          ## ğŸŒŸ Branch-Based Release Strategy

          ### ğŸ“Š Release Information
          | Property | Value |
          |----------|-------|
          | ğŸ”€ Branch | \`$branch_name\` |
          | ğŸ·ï¸ Version | \`$new_version\` |
          | ğŸ“¦ Previous | \`$previous_tag\` |
          | ğŸš€ Type | \`$release_type\` |
          | ğŸ¤– Trigger | ${{ github.event_name }} |
          | ğŸ“ Commit | \`$commit_sha\` |

          ### ğŸ“¦ Artifacts Included
          - ğŸ“„ Bicep templates compiled to ARM templates
          - ğŸ—ï¸ Infrastructure deployment files
          - ğŸ“‹ Release metadata and documentation

          ### ğŸ”— Links
          - [Commit History](https://github.com/${{ github.repository }}/commits/$branch_name)
          - [Compare Changes](https://github.com/${{ github.repository }}/compare/$previous_tag...$new_version)
          EOF

          echo "is_prerelease=$is_prerelease" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@72f2c25fcb47643c292f7107632f7a47c1df5cd8 # v2.3.2
        with:
          tag_name: ${{ needs.generate-release.outputs.new_version }}
          name: Release ${{ needs.generate-release.outputs.new_version }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ steps.release_notes.outputs.is_prerelease }}
          generate_release_notes: true
          files: |
            ./artifacts/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Summary
        shell: bash
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ‰ Release Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ needs.generate-release.outputs.new_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[View Release](https://github.com/${{ github.repository }}/releases/tag/${{ needs.generate-release.outputs.new_version }})" >> $GITHUB_STEP_SUMMARY

  # ğŸ“Š Summary job for workflow status
  summary:
    name: Workflow Summary
    runs-on: ubuntu-latest
    needs: [generate-release, build, publish-release]
    if: always()
    steps:
      - name: Workflow Summary
        shell: bash
        run: |
          echo "ğŸ“Š Workflow Execution Summary"
          echo "================================"
          echo ""
          echo "ğŸ”€ Branch: ${{ needs.generate-release.outputs.branch_name || 'N/A' }}"
          echo "ğŸ·ï¸ Version: ${{ needs.generate-release.outputs.new_version || 'N/A' }}"
          echo "ğŸš€ Release Type: ${{ needs.generate-release.outputs.release_type || 'N/A' }}"
          echo "ğŸ¤– Trigger: ${{ github.event_name }}"
          echo ""
          echo "ğŸ“‹ Job Status:"
          echo "  - Generate Release: ${{ needs.generate-release.result }}"
          echo "  - Build: ${{ needs.build.result }}"
          echo "  - Publish Release: ${{ needs.publish-release.result }}"
          echo ""
          if [[ "${{ needs.publish-release.result }}" == "success" ]]; then
            echo "âœ… Release published successfully!"
          elif [[ "${{ needs.generate-release.outputs.should_publish }}" == "false" ]]; then
            echo "â„¹ï¸  Development build completed. Tag created but no release published."
          else
            echo "âš ï¸  Workflow completed with issues. Check individual job logs."
          fi
