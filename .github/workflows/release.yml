name: Branch-Based Release Strategy

on:
  # Manual workflow dispatch for all branches
  workflow_dispatch:
    inputs:
      force_release:
        description: 'Force create a release (even for non-main branches)'
        required: false
        default: false
        type: boolean
  
  # Automatic triggers
  push:
    branches:
      - main           # Auto-release from main branch
      - 'feature/**'   # Build and tag feature branches (no release)
      - 'fix/**'       # Build and tag fix branches (no release)
  
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened]
          
permissions:
  contents: write
  pull-requests: read
  actions: read

jobs:
  # ğŸ” Generate release metadata and version information
  generate-release:
    name: Generate Release Metadata
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.release.outputs.new_version }}
      release_type: ${{ steps.release.outputs.release_type }}
      previous_tag: ${{ steps.release.outputs.previous_tag }}
      should_release: ${{ steps.release.outputs.should_release }}
      should_publish: ${{ steps.release.outputs.should_publish }}
      branch_name: ${{ steps.release.outputs.branch_name }}
      commit_sha: ${{ github.sha }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'pull_request' && github.head_ref || github.ref }}
          fetch-depth: 0  # Full history for proper tag analysis

      - name: Generate Release Information
        id: release
        uses: ./.github/actions/ci/generate-release

      - name: Release Strategy Summary
        shell: bash
        run: |
          echo "ğŸŒŸ Branch-Based Release Strategy with Conditional Major Increment"
          echo ""
          echo "ğŸ”€ Branch: ${{ steps.release.outputs.branch_name }}"
          echo "ğŸ·ï¸ Version: ${{ steps.release.outputs.new_version }}"
          echo "ğŸ“¦ Previous Version: ${{ steps.release.outputs.previous_tag }}"
          echo "ğŸš€ Release Type: ${{ steps.release.outputs.release_type }}"
          echo "ğŸ¤– Trigger: ${{ github.event_name }}"
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo ""
          echo "Release Strategy Applied:"
          echo "ğŸ¯ Main Branch: Conditional major increment (only if minor=0 AND patch=0, otherwise increment patch with overflow logic)"
          echo ""
          echo "Main Branch Logic (NEW RULE):"
          echo "â€¢ If minor=0 AND patch=0: Increment major â†’ major+1.0.0"
          echo "â€¢ If minorâ‰ 0 OR patchâ‰ 0: Keep major, increment patch â†’ major.minor.(patch+1)"
          echo "â€¢ Overflow handling: If patch > 99 â†’ minor+1, patch=0; if minor > 99 â†’ major+1, minor=0"
          echo ""
          echo "Feature/Fix Branch Overflow Logic:"
          echo "â€¢ Feature branches: If patch + commits > 99 â†’ patch = 0, minor += 1"
          echo "â€¢ Fix branches: If minor + commits > 99 â†’ minor = 0, major += 1"
          echo "â€¢ Cascading overflow: If minor overflows during patch overflow â†’ minor = 0, major += 1"

  # ğŸ—ï¸ Build artifacts and compile Bicep templates
  build:
    name: Build Artifacts
    runs-on: ubuntu-latest
    needs: generate-release
    if: needs.generate-release.outputs.should_release == 'true'
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'pull_request' && github.head_ref || github.ref }}
          fetch-depth: 0

      - name: Build Bicep Templates and Create Artifacts
        id: build
        uses: ./.github/actions/ci/bicep-standard-ci
        with:
          branch_name: ${{ needs.generate-release.outputs.branch_name }}
          new_version: ${{ needs.generate-release.outputs.new_version }}
          should_publish: ${{ needs.generate-release.outputs.should_publish }}

      - name: Build Summary
        shell: bash
        run: |
          echo "ğŸ“¦ Build Artifacts Created:"
          echo "  - ğŸ“„ Bicep templates compiled to ARM templates"
          echo "  - ğŸ—ï¸ Infrastructure deployment files"
          echo "  - ğŸ“‹ Release metadata and documentation"
          echo "  - ğŸ·ï¸ Version: ${{ needs.generate-release.outputs.new_version }}"
          echo "  - ğŸ”€ Branch: ${{ needs.generate-release.outputs.branch_name }}"

  # ğŸ“¢ Publish GitHub Release (only for main branch or forced releases)
  publish-release:
    name: Publish GitHub Release
    runs-on: ubuntu-latest
    needs: [generate-release, build]
    if: |
      needs.generate-release.outputs.should_release == 'true' && 
      (needs.generate-release.outputs.should_publish == 'true' || 
       github.event.inputs.force_release == 'true')
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'pull_request' && github.head_ref || github.ref }}
          fetch-depth: 0

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: artifacts-${{ needs.generate-release.outputs.new_version }}
          path: ./artifacts

      - name: Generate Release Notes
        id: release_notes
        shell: bash
        run: |
          branch_name="${{ needs.generate-release.outputs.branch_name }}"
          release_type="${{ needs.generate-release.outputs.release_type }}"
          previous_tag="${{ needs.generate-release.outputs.previous_tag }}"
          new_version="${{ needs.generate-release.outputs.new_version }}"
          commit_sha="${{ needs.generate-release.outputs.commit_sha }}"
          
          # Determine if this is a prerelease
          is_prerelease="false"
          if [[ "$branch_name" != "main" ]] || [[ "$new_version" == *"-"* ]]; then
            is_prerelease="true"
          fi
          
          # Generate release body
          cat > release_notes.md << EOF
          ## ğŸŒŸ Branch-Based Release Strategy with Conditional Major Increment
          
          ### ğŸ“Š Release Information
          - **ğŸ”€ Branch:** \`$branch_name\`
          - **ğŸ·ï¸ Version:** \`$new_version\`
          - **ğŸ“¦ Previous Version:** \`$previous_tag\`
          - **ğŸš€ Release Type:** \`$release_type\`
          - **ğŸ¤– Trigger:** ${{ github.event_name }}
          - **ğŸ“ Commit:** \`$commit_sha\`
          
          ### ğŸ¯ Release Strategy Applied
          **Main Branch:** Conditional major increment (only if minor=0 AND patch=0, otherwise increment patch with overflow logic)
          
          #### Main Branch Logic (NEW RULE)
          - **If minor=0 AND patch=0:** Increment major â†’ major+1.0.0
          - **If minorâ‰ 0 OR patchâ‰ 0:** Keep major, increment patch â†’ major.minor.(patch+1)
          - **Overflow handling:** If patch > 99 â†’ minor+1, patch=0; if minor > 99 â†’ major+1, minor=0
          
          #### Feature/Fix Branch Overflow Logic
          - **Feature branches:** If patch + commits > 99 â†’ patch = 0, minor += 1
          - **Fix branches:** If minor + commits > 99 â†’ minor = 0, major += 1
          - **Cascading overflow:** If minor overflows during patch overflow â†’ minor = 0, major += 1
          
          ### ğŸ“¦ Artifacts
          - ğŸ“„ Bicep templates compiled to ARM templates
          - ğŸ—ï¸ Infrastructure deployment files
          - ğŸ“‹ Release metadata and documentation
          
          ### ğŸ”— Links
          - [Commit History](https://github.com/${{ github.repository }}/commits/$branch_name)
          - [Compare Changes](https://github.com/${{ github.repository }}/compare/$previous_tag...$new_version)
          EOF
          
          echo "is_prerelease=$is_prerelease" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.generate-release.outputs.new_version }}
          name: Release ${{ needs.generate-release.outputs.new_version }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ steps.release_notes.outputs.is_prerelease }}
          generate_release_notes: true
          files: |
            ./artifacts/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Published
        shell: bash
        run: |
          echo "ğŸ‰ Release ${{ needs.generate-release.outputs.new_version }} has been published!"
          echo "ğŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ needs.generate-release.outputs.new_version }}"

  # ğŸ“Š Summary job for workflow status
  summary:
    name: Workflow Summary
    runs-on: ubuntu-latest
    needs: [generate-release, build, publish-release]
    if: always()
    steps:
      - name: Workflow Summary
        shell: bash
        run: |
          echo "ğŸ“Š Workflow Execution Summary"
          echo "================================"
          echo ""
          echo "ğŸ”€ Branch: ${{ needs.generate-release.outputs.branch_name || 'N/A' }}"
          echo "ğŸ·ï¸ Version: ${{ needs.generate-release.outputs.new_version || 'N/A' }}"
          echo "ğŸš€ Release Type: ${{ needs.generate-release.outputs.release_type || 'N/A' }}"
          echo "ğŸ¤– Trigger: ${{ github.event_name }}"
          echo ""
          echo "ğŸ“‹ Job Status:"
          echo "  - Generate Release: ${{ needs.generate-release.result }}"
          echo "  - Build: ${{ needs.build.result }}"
          echo "  - Publish Release: ${{ needs.publish-release.result }}"
          echo ""
          if [[ "${{ needs.publish-release.result }}" == "success" ]]; then
            echo "âœ… Release published successfully!"
          elif [[ "${{ needs.generate-release.outputs.should_publish }}" == "false" ]]; then
            echo "â„¹ï¸  Development build completed. Tag created but no release published."
          else
            echo "âš ï¸  Workflow completed with issues. Check individual job logs."
          fi

  