{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.30.3.12046",
      "templateHash": "13259543372401544161"
    }
  },
  "parameters": {
    "devCenterName": {
      "type": "string"
    },
    "networkConnectionName": {
      "type": "string"
    },
    "identityName": {
      "type": "string"
    },
    "customRoleName": {
      "type": "string"
    },
    "computeGalleryName": {
      "type": "string"
    },
    "computeGalleryImageName": {
      "type": "string"
    }
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "identity",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "identityName": {
            "value": "[parameters('identityName')]"
          },
          "customRoleName": {
            "value": "[parameters('customRoleName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.30.3.12046",
              "templateHash": "3166144899414148019"
            }
          },
          "parameters": {
            "identityName": {
              "type": "string"
            },
            "customRoleName": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "deployIdentity",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[resourceGroup().location]"
                  },
                  "identityName": {
                    "value": "[parameters('identityName')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.30.3.12046",
                      "templateHash": "9593189490181953382"
                    }
                  },
                  "parameters": {
                    "identityName": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
                      "apiVersion": "2023-01-31",
                      "name": "[parameters('identityName')]",
                      "location": "[parameters('location')]"
                    }
                  ],
                  "outputs": {
                    "identityName": {
                      "type": "string",
                      "value": "[parameters('identityName')]"
                    },
                    "identityResourceId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('identityName'))]"
                    },
                    "identityPrincipalId": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('identityName')), '2023-01-31').principalId]"
                    },
                    "identityClientId": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('identityName')), '2023-01-31').clientId]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "deployCustomRole",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "customRoleName": {
                    "value": "[parameters('customRoleName')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.30.3.12046",
                      "templateHash": "15401327685848454702"
                    }
                  },
                  "parameters": {
                    "customRoleName": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Authorization/roleDefinitions",
                      "apiVersion": "2022-04-01",
                      "name": "[guid(subscription().subscriptionId, parameters('customRoleName'))]",
                      "properties": {
                        "roleName": "[parameters('customRoleName')]",
                        "description": "Custom role for managing custom images",
                        "assignableScopes": [
                          "[resourceGroup().id]",
                          "[subscription().id]"
                        ],
                        "permissions": [
                          {
                            "actions": [
                              "Microsoft.Compute/galleries/images/write",
                              "Microsoft.Compute/galleries/images/read",
                              "Microsoft.Compute/galleries/images/delete",
                              "Microsoft.Compute/galleries/images/versions/write",
                              "Microsoft.Compute/galleries/images/versions/read",
                              "Microsoft.Compute/galleries/images/versions/delete"
                            ],
                            "notActions": [],
                            "dataActions": [],
                            "notDataActions": []
                          }
                        ]
                      }
                    }
                  ],
                  "outputs": {
                    "customRoleName": {
                      "type": "string",
                      "value": "[guid(subscription().subscriptionId, parameters('customRoleName'))]"
                    },
                    "customRoleId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Authorization/roleDefinitions', guid(subscription().subscriptionId, parameters('customRoleName')))]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'deployIdentity')]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "identityCustomRoleAssignment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "customRoleName": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deployCustomRole'), '2022-09-01').outputs.customRoleName.value]"
                  },
                  "identityId": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deployIdentity'), '2022-09-01').outputs.identityPrincipalId.value]"
                  },
                  "customRoleId": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deployCustomRole'), '2022-09-01').outputs.customRoleId.value]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.30.3.12046",
                      "templateHash": "18207227460544341458"
                    }
                  },
                  "parameters": {
                    "customRoleName": {
                      "type": "string"
                    },
                    "identityId": {
                      "type": "string"
                    },
                    "customRoleId": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "name": "[guid(subscription().subscriptionId, parameters('customRoleName'))]",
                      "properties": {
                        "roleDefinitionId": "[parameters('customRoleId')]",
                        "principalId": "[parameters('identityId')]",
                        "principalType": "ServicePrincipal"
                      }
                    }
                  ],
                  "outputs": {
                    "customRoleAssignmentName": {
                      "type": "string",
                      "value": "[guid(subscription().subscriptionId, parameters('customRoleName'))]"
                    },
                    "customRoleAssignmentId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Authorization/roleAssignments', guid(subscription().subscriptionId, parameters('customRoleName')))]"
                    },
                    "customRoleAssignmentScope": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.Authorization/roleAssignments', guid(subscription().subscriptionId, parameters('customRoleName'))), '2022-04-01').scope]"
                    },
                    "customRoleAssignmentPrincipalId": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.Authorization/roleAssignments', guid(subscription().subscriptionId, parameters('customRoleName'))), '2022-04-01').principalId]"
                    },
                    "customRoleAssignmentRoleDefinitionId": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.Authorization/roleAssignments', guid(subscription().subscriptionId, parameters('customRoleName'))), '2022-04-01').roleDefinitionId]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'deployCustomRole')]",
                "[resourceId('Microsoft.Resources/deployments', 'deployIdentity')]"
              ]
            }
          ],
          "outputs": {
            "identityName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deployIdentity'), '2022-09-01').outputs.identityName.value]"
            },
            "ideidentityClientIdntityId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deployIdentity'), '2022-09-01').outputs.identityClientId.value]"
            },
            "identityPrincipalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deployIdentity'), '2022-09-01').outputs.identityPrincipalId.value]"
            },
            "identityResourceId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deployIdentity'), '2022-09-01').outputs.identityResourceId.value]"
            },
            "userAssignedIdentityId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deployCustomRole'), '2022-09-01').outputs.customRoleId.value]"
            },
            "userAssignedIdentityName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deployCustomRole'), '2022-09-01').outputs.customRoleName.value]"
            },
            "customRoleAssignmentName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'identityCustomRoleAssignment'), '2022-09-01').outputs.customRoleAssignmentName.value]"
            },
            "customRoleAssignmentId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'identityCustomRoleAssignment'), '2022-09-01').outputs.customRoleAssignmentId.value]"
            },
            "customRoleAssignmentScope": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'identityCustomRoleAssignment'), '2022-09-01').outputs.customRoleAssignmentScope.value]"
            },
            "customRoleAssignmentPrincipalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'identityCustomRoleAssignment'), '2022-09-01').outputs.customRoleAssignmentPrincipalId.value]"
            },
            "customRoleAssignmentRoleDefinitionId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'identityCustomRoleAssignment'), '2022-09-01').outputs.customRoleAssignmentRoleDefinitionId.value]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "computeGallery",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "computeGalleryName": {
            "value": "[parameters('computeGalleryName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.30.3.12046",
              "templateHash": "6650397055020221624"
            }
          },
          "parameters": {
            "computeGalleryName": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Compute/galleries",
              "apiVersion": "2023-07-03",
              "name": "[parameters('computeGalleryName')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Compute gallery for Microsoft Dev Box Custom Images"
              }
            }
          ],
          "outputs": {
            "computeGalleryId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Compute/galleries', parameters('computeGalleryName'))]"
            },
            "computeGalleryName": {
              "type": "string",
              "value": "[parameters('computeGalleryName')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'identity')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "devCenter",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "devCenterName": {
            "value": "[parameters('devCenterName')]"
          },
          "devBoxDefinitionName": {
            "value": "[resourceId('Microsoft.Network/networkConnections', parameters('networkConnectionName'))]"
          },
          "computeGalleryId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'computeGallery'), '2022-09-01').outputs.computeGalleryId.value]"
          },
          "location": {
            "value": "[resourceGroup().location]"
          },
          "networkConnectionName": {
            "value": "[parameters('networkConnectionName')]"
          },
          "userIdentityId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'identity'), '2022-09-01').outputs.identityPrincipalId.value]"
          },
          "computeGalleryName": {
            "value": "[parameters('computeGalleryName')]"
          },
          "computeGalleryImageName": {
            "value": "[parameters('computeGalleryImageName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.30.3.12046",
              "templateHash": "8761380378179370593"
            }
          },
          "parameters": {
            "devCenterName": {
              "type": "string"
            },
            "devBoxDefinitionName": {
              "type": "string"
            },
            "computeGalleryId": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "networkConnectionName": {
              "type": "string"
            },
            "userIdentityId": {
              "type": "string"
            },
            "computeGalleryName": {
              "type": "string"
            },
            "computeGalleryImageName": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.DevCenter/devcenters",
              "apiVersion": "2024-02-01",
              "name": "[parameters('devCenterName')]",
              "location": "[parameters('location')]",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('userIdentityId'))]": {}
                }
              },
              "properties": {}
            },
            {
              "type": "Microsoft.DevCenter/devcenters/catalogs",
              "apiVersion": "2024-02-01",
              "name": "[format('{0}/{1}', parameters('devCenterName'), 'quickstart-devbox-tasks')]",
              "properties": {
                "gitHub": {
                  "uri": "https://github.com/Evilazaro/MicrosoftDevBox.git",
                  "branch": "main",
                  "path": "src/customizations/tasks"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.DevCenter/devcenters', parameters('devCenterName'))]"
              ]
            },
            {
              "type": "Microsoft.DevCenter/devcenters/attachednetworks",
              "apiVersion": "2024-02-01",
              "name": "[format('{0}/{1}', parameters('devCenterName'), parameters('networkConnectionName'))]",
              "properties": {
                "networkConnectionId": "[resourceId('Microsoft.Network/networkConnections', parameters('networkConnectionName'))]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.DevCenter/devcenters', parameters('devCenterName'))]"
              ]
            },
            {
              "type": "Microsoft.DevCenter/devcenters/galleries",
              "apiVersion": "2024-02-01",
              "name": "[format('{0}/{1}', parameters('devCenterName'), parameters('computeGalleryName'))]",
              "properties": {
                "galleryResourceId": "[parameters('computeGalleryId')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.DevCenter/devcenters', parameters('devCenterName'))]"
              ]
            }
          ],
          "outputs": {
            "devCenterId": {
              "type": "string",
              "value": "[resourceId('Microsoft.DevCenter/devcenters', parameters('devCenterName'))]"
            },
            "devCenterName": {
              "type": "string",
              "value": "[parameters('devCenterName')]"
            },
            "devCenterName_quickstart_devbox_tasks_id": {
              "type": "string",
              "value": "[resourceId('Microsoft.DevCenter/devcenters/catalogs', parameters('devCenterName'), 'quickstart-devbox-tasks')]"
            },
            "devCenterName_quickstart_devbox_tasks_name": {
              "type": "string",
              "value": "quickstart-devbox-tasks"
            },
            "devCenterName_networkConnection_id": {
              "type": "string",
              "value": "[resourceId('Microsoft.DevCenter/devcenters/attachednetworks', parameters('devCenterName'), parameters('networkConnectionName'))]"
            },
            "devCenterName_networkConnection_name": {
              "type": "string",
              "value": "[parameters('networkConnectionName')]"
            },
            "devCenterName_computeGalleryImage_id": {
              "type": "string",
              "value": "[resourceId('Microsoft.DevCenter/devcenters/galleries', parameters('devCenterName'), parameters('computeGalleryName'))]"
            },
            "devCenterName_computeGalleryImage_name": {
              "type": "string",
              "value": "[parameters('computeGalleryName')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'computeGallery')]",
        "[resourceId('Microsoft.Resources/deployments', 'identity')]"
      ]
    }
  ],
  "outputs": {
    "userIdentityId": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'identity'), '2022-09-01').outputs.identityPrincipalId.value]"
    },
    "userIdentityName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'identity'), '2022-09-01').outputs.identityName.value]"
    },
    "computeGalleryId": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'computeGallery'), '2022-09-01').outputs.computeGalleryId.value]"
    },
    "computeGalleryName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'computeGallery'), '2022-09-01').outputs.computeGalleryName.value]"
    }
  }
}