# =============================================================================
# File: azure-pwh.yaml
# Purpose: Azure Developer CLI (azd) configuration for Dev Box Accelerator
# Description: Defines deployment hooks and environment setup for Windows (PowerShell)
# =============================================================================
# yaml-language-server: $schema=https://raw.githubusercontent.com/Azure/azure-dev/refs/heads/main/schemas/v1.0/azure.yaml.json

# Project name used by azd for environment naming and resource tagging
name: ContosoDevExp

hooks:
  preprovision:
    shell: pwsh
    continueOnError: false
    interactive: true
    run: |
      # PowerShell preprovision script
      $ErrorActionPreference = 'Stop'
      $defaultPlatform = 'github'

      if (-not $env:SOURCE_CONTROL_PLATFORM -or $env:SOURCE_CONTROL_PLATFORM -eq '') {
          Write-Output "SOURCE_CONTROL_PLATFORM is not set. Setting it to '$defaultPlatform' by default."
          $env:SOURCE_CONTROL_PLATFORM = $defaultPlatform
      } else {
          Write-Output "Existing SOURCE_CONTROL_PLATFORM is set to '$($env:SOURCE_CONTROL_PLATFORM)'."
      }

      # Run setup.sh (use bash if available)
      if (Get-Command bash -ErrorAction SilentlyContinue) {
          & bash -c "./setup.sh -e $env:AZURE_ENV_NAME -s $env:SOURCE_CONTROL_PLATFORM"
      } else {
          Write-Output "bash not found; attempting to execute ./setup.sh directly"
          & ./setup.sh -e $env:AZURE_ENV_NAME -s $env:SOURCE_CONTROL_PLATFORM
      }
